<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <link rel="stylesheet" type="text/css" href="style.css">
  <title>問題一覧</title>
  <style>
    .hidden { display: none; }
    .tabs { display: flex; margin-bottom: 10px; }
    .tab { padding: 10px 20px; cursor: pointer; border: 1px solid #aaa; border-bottom: none; background: #fcfcfc; }
    .tab.active { background: rgb(172, 154, 252); font-weight: bold; }
    .tab-content { border: 1px solid #aaa; padding: 15px; display: none; }
    .tab-content.active { display: block; }
  </style>
</head>

<body>
  
  <!-- ログインフォーム -->
  <div id="loginSection">
    <form id="loginForm">
      <h1>ログインページ</h1>
      <label>ユーザーID: <input type="text" name="userid" required></label><br>

      <label>パスワード: <input type="password" name="password" required></label><br>

      <button type="submit">ログイン</button>
    </form>
    <p id="loginMessage"></p>

    <p>新規登録は<a href='register_form.html'>こちら</a></p>
  </div>

  <!-- ログイン後に見える部分 -->
  <div id="mainSection" class="hidden">
    <h2 id="welcome"></h2>
    
    <!--タブ選択-->
    <div class="tabs">
      <div class="tab active" data-target="quiz">問題</div>
      <div class="tab" data-target="score">得点</div>
      <div class="tab" data-target="result_check">ランキング</div>
    </div>

  <!--タブの内容-->
  <div id="quiz" class="tab-content active">
    <div id="quizContainer"></div>

    <!-- モーダル -->
    <div id="modal" class="modal">
      <div class="modal-content">
        <span class="close" onclick="closeModal()">&times;</span>
        <h2 id="modal-title"></h2>
        <p id="modal-desc"></p>
        <p><strong>得点:</strong> <span id="modal-point"></span> 点</p>
        <details>
          <summary>ヒント</summary>
          <div id="modal-hints"></div>
        </details>
        <input type="text" id="answer" placeholder="FLAG{...}">
        <button id="submitBtn">送信</button>
        <p id="result"></p>
      </div>
    </div>
  </div>

  <!--得点表示-->
  <div id="score" class="tab-content">
    <h2>得点</h2>
    <p id="scoreDisplay">現在の得点: -</p>
    <button onclick="loadScore()">最新スコア取得</button>
  </div>

  <!--ランキング表示-->
  <div id="result_check" class="tab-content">
    <h2>ランキング</h2>
    <table id="ranking">
    <thead>
      <tr><th>順位</th><th>ユーザー名</th><th>スコア</th></tr>
    </thead>
    <tbody>
        
    </tbody>
    </table>
      <p>ちょっと形になったよ</p>
    </div>
  </div>

  <script>
    let quizData = {};
    let currentCategory = null;
    let currentQid = null;
    let currentPoint = 0;
    // ログイン処理
    document.getElementById("loginForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const data = {
        userid: e.target.userid.value,
        password: e.target.password.value
      };

      const res = await fetch("/login", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data)
      });
      const result = await res.json();

      if (result.success) {
        document.getElementById("loginMessage").innerText = "";
        document.getElementById("loginSection").classList.add("hidden");
        document.getElementById("mainSection").classList.remove("hidden");
        //document.getElementById("registerForm").classList.add("hidden");
        document.getElementById("welcome").innerText = "ようこそ " + result.username + " さん！";
      } else {
        document.getElementById("loginMessage").innerText = result.message;
      }
    });

    // タブ切り替え
    const tabs = document.querySelectorAll(".tab");
    const contents = document.querySelectorAll(".tab-content");
    tabs.forEach(tab => {
      tab.addEventListener("click", () => {
        // すべてのタブ・内容をいったん非アクティブにする
        tabs.forEach(t => t.classList.remove("active"));
        contents.forEach(c => c.classList.remove("active"));
        // クリックされたタブと、そのタブに対応する内容だけを表示
        tab.classList.add("active");
        document.getElementById(tab.dataset.target).classList.add("active");
        if (tab.dataset.target === "result_check") {
            console.log("ランキングタブがクリックされました");
          loadRanking(); // ← ランキングタブを開いたとき実行
        }
        else if (tab.dataset.target === "score") {
          console.log("得点タブがクリックされました");
            loadScore(); // ← 得点タブを開いたとき実行
        }
      });
    });

    // スコア読み込み
    async function loadScore() {
      const res = await fetch("/getScore");
      const result = await res.json();
      document.getElementById("scoreDisplay").innerText = "現在の得点: " + result.score;
    }

    //スコアランキング
    async function loadRanking() {
      const res = await fetch("/ranking");
      const data = await res.json();

      const tbody = document.querySelector("#ranking tbody");
      tbody.innerHTML = "";

      data.forEach((user, index) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${index + 1}</td>
          <td>${user.userid || user.username}</td>
          <td>${user.score}</td>
        `;
        tbody.appendChild(tr);
      });
    }
        // JSONから問題一覧を生成
    async function loadQuizData() {
      const res = await fetch("/api/quizData");
      quizData = await res.json();

      const container = document.getElementById("quizContainer");
      container.innerHTML = "";

      for (const [category, questions] of Object.entries(quizData)) {
        // カテゴリタイトル
        const h1 = document.createElement("h1");
        h1.textContent = category;
        container.appendChild(h1);

        const grid = document.createElement("div");
        grid.className = "grid";

        // 各問題をボタンとして生成
        for (const [qid, q] of Object.entries(questions)) {
          const div = document.createElement("div");
          div.className = "challenge";
          div.innerHTML = `
            <div>${q.title}</div>
            <div class="points">${q.point}点</div>
          `;
          div.onclick = () => openModal(category, qid);
          grid.appendChild(div);
        }

        container.appendChild(grid);
      }
    }

    // モーダル開く
    function openModal(category, qid) {
      const q = quizData[category][qid];
      currentCategory = category;
      currentQid = qid;
      currentPoint = q.point;

      document.getElementById("modal-title").textContent = q.title;
      document.getElementById("modal-desc").textContent = q.desc;
      document.getElementById("modal-point").textContent = q.point;
      document.getElementById("modal-hints").innerHTML =
        q.hint.map(h => `<div>・${h}</div>`).join("");
      document.getElementById("modal").style.display = "flex";
    }

    // モーダル閉じる
    function closeModal() {
      document.getElementById("modal").style.display = "none";
    }

    // 背景クリックで閉じる
    window.onclick = (e) => {
      if (e.target === document.getElementById("modal")) closeModal();
    };

    // 答え送信
    document.getElementById("submitBtn").addEventListener("click", async (e) => {
      e.preventDefault();
      const answer = document.getElementById("answer").value;

      const res = await fetch("/checkAnswer", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({
          category: currentCategory,
          qid: currentQid,
          answer: answer,
          point: currentPoint
        })
      });
      const data = await res.json();
      document.getElementById("result").innerText = data.correct ? "正解！" : "不正解…";
    });

    loadQuizData(); // 初期ロード
  </script>
</body>
</html>
