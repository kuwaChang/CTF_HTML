<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <link rel="stylesheet" type="text/css" href="style.css">
  <title>ログインページ</title>
  <style>
    .hidden { display: none; }
    .tabs { display: flex; margin-bottom: 10px; }
    .tab { padding: 10px 20px; cursor: pointer; border: 1px solid #aaa; border-bottom: none; background: #fcfcfc; }
    .tab.active { background: rgb(172, 154, 252); font-weight: bold; }
    .tab-content { border: 1px solid #aaa; padding: 15px; display: none; }
    .tab-content.active { display: block; }
  </style>
</head>

<body>
  
  <!-- ログインフォーム -->
  <div id="loginSection">
    <form id="loginForm">
      <h1>ログインページ</h1>
      <label>ユーザーID: <input type="text" name="userid" required></label><br>

      <label>パスワード: <input type="password" name="password" required></label><br>

      <button type="submit">ログイン</button>
    </form>
    <p id="loginMessage"></p>

    <p>新規登録は<a href='register_form.html'>こちら</a></p>
  </div>

  <!-- ログイン後に見える部分 -->
  <div id="mainSection" class="hidden">
    <h2 id="welcome"></h2>
    
    <!--タブ選択-->
    <div class="tabs">
      <div class="tab active" data-target="quiz">問題</div>
      <div class="tab" data-target="score">得点</div>
      <div class="tab" data-target="result_check">ランキング</div>
    </div>

  <!--タブの内容-->
  <div id="quiz" class="tab-content active">
    <!--カテゴリー名-->  
    <h1>TEST</h1>
    <div class="grid">
      <!--各問題のタイトル-->
      <div class="challenge" onclick="openModal('TEST', 'test1')">
        <div>test1</div>
        <div class="points">15</div>
      </div>

      <div class="challenge" onclick="openModal('TEST', 'test2')">
        <div>test2</div>
        <div class="points">20</div>
      </div>

      <div class="challenge" onclick="openModal('TEST', 'test3')">
        <div>test3</div>
        <div class="points">30</div>
      </div>

      <div class="challenge" onclick="openModal('TEST', 'test4')">
        <div>test4</div>
        <div class="points">100</div>
      </div>
    </div>
    

    <h1>Reversing</h1>
    <div class="grid">
      <!--各問題のタイトル-->
      <div class="challenge" onclick="openModal('Reversing', 'want_to_execute')">
        <div>want_to_execute</div>
        <div class="points">15</div>
      </div>

      <div class="challenge" onclick="openModal('Reversing', 'Passchecker')">
        <div>Passchecker</div>
        <div class="points">20</div>
      </div>

      <div class="challenge" onclick="openModal('Reversing', 'Password Crack!')">
        <div>Password Crack!</div>
        <div class="points">30</div>
      </div>

      <div class="challenge" onclick="openModal('Reversing', 'Ghidra Tutorial')">
        <div>Ghidra Tutorial</div>
        <div class="points">100</div>
      </div>
    </div>

    <!--カテゴリー名-->
    <h1>Web</h1>
    <div class="grid">
      <!--各問題のタイトル-->
      <div class="challenge" onclick="openModal('Web', 'web1')">
        <div>web1</div>
        <div class="points">15</div>
      </div>

      <div class="challenge" onclick="openModal('Web', 'web2')">
        <div>web2</div>
        <div class="points">20</div>
      </div>

      <div class="challenge" onclick="openModal('Web', 'web3')">
        <div>web3</div>
        <div class="points">30</div>
      </div>

      <div class="challenge" onclick="openModal('web4')">
        <div>web4</div>
        <div class="points">100</div>
      </div>
    </div>

    <!--カテゴリー名-->
    <h1>Pwn</h1>
    <div class="grid">
      <!--各問題のタイトル-->
      <div class="challenge" onclick="openModal('Pwn', 'Super_Command1')">
        <div>Super_Command1</div>
        <div class="points">15</div>
      </div>

      <div class="challenge" onclick="openModal('Pwn', 'Super_Command2')">
        <div>Super_Command2</div>
        <div class="points">20</div>
      </div>

      <div class="challenge" onclick="openModal('Pwn', 'Super_Command3')">
        <div>Super_Command3</div>
        <div class="points">30</div>
      </div>

      <div class="challenge" onclick="openModal('Pwn', 'Super_Command4')">
        <div>Super_Command4</div>
        <div class="points">100</div>
      </div>
    </div>

    <!--カテゴリー名-->
    <h1>PPC</h1>
    <div class="grid">
      <!--各問題のタイトル-->
      <div class="challenge" onclick="openModal('PPC', 'Scratch Lv.1')">
        <div>Scratch Lv.1</div>
        <div class="points">15</div>
      </div>

      <div class="challenge" onclick="openModal('PPC', 'Scratch Lv.2')">
        <div>Scratch Lv.2</div>
        <div class="points">20</div>
      </div>
    </div>

    <!--カテゴリー名-->
    <h1>OSINT</h1>
    <div class="grid">
      <!--各問題のタイトル-->
      <div class="challenge" onclick="openModal('OSINT', 'People Search')">
        <div>People Search</div>
        <div class="points">15</div>
      </div>

      <div class="challenge" onclick="openModal('OSINT', 'You are here')">
        <div>You are here</div>
        <div class="points">20</div>
      </div>

      <div class="challenge" onclick="openModal('OSINT', 'Where are you')">
        <div>Where are you</div>
        <div class="points">30</div>
      </div>

      <div class="challenge" onclick="openModal('OSINT', 'Flight record')">
        <div>Flight record</div>
        <div class="points">100</div>
      </div>

      <div class="challenge" onclick="openModal('OSINT', 'ここはココア？')">
        <div>ここはココア？</div>
        <div class="points">100</div>
      </div>

      <div class="challenge" onclick="openModal('OSINT', 'Cyberstalking1 ~Story~')">
        <div>Cyberstalking1 ~Story~</div>
        <div class="points">100</div>
      </div>

      <div class="challenge" onclick="openModal('OSINT', 'ONNN-K')">
        <div>ONNN-K</div>
        <div class="points">100</div>
      </div>

      <div class="challenge" onclick="openModal('OSINT', '一休み')">
        <div>一休み</div>
        <div class="points">100</div>
      </div>

      <div class="challenge" onclick="openModal('OSINT', 'ramen with me')">
        <div>ramen with me</div>
        <div class="points">100</div>
      </div>

      <div class="challenge" onclick="openModal('park?')">
        <div>park?</div>
        <div class="points">100</div>
      </div>

      <div class="challenge" onclick="openModal('OSINT', 'Cyberstalking1 ~Tweet~')">
        <div>Cyberstalking1 ~Tweet~</div>
        <div class="points">100</div>
      </div>

      <div class="challenge" onclick="openModal('OSINT', 'Cyberstalking2 ~Tweet~')">
        <div>Cyberstalking2 ~Tweet~</div>
        <div class="points">100</div>
      </div>
    </div>

    <!--カテゴリー名-->
    <h1>Forensics</h1>
    <div class="grid">
      <!--各問題のタイトル-->
      <div class="challenge" onclick="openModal('Forensics', 'Welcome!')">
        <div>Welcome!</div>
        <div class="points">15</div>
      </div>

      <div class="challenge" onclick="openModal('Forensics', 'ここどこ？')">
        <div>ここどこ？</div>
        <div class="points">20</div>
      </div>

      <div class="challenge" onclick="openModal('Forensics', 'プロパティ')">
        <div>プロパティ</div>
        <div class="points">30</div>
      </div>

      <div class="challenge" onclick="openModal('Forensics', '真っ白')">
        <div>真っ白</div>
        <div class="points">100</div>
      </div>
    </div>

    <!--カテゴリー名-->
    <h1>Crypto</h1>
    <div class="grid">
      <!--各問題のタイトル-->
      <div class="challenge" onclick="openModal('Crypto', 'ROT')">
        <div>ROT</div>
        <div class="points">15</div>
      </div>

      <div class="challenge" onclick="openModal('Crypto', '手動でやるのはつらいヤツ')">
        <div>手動でやるのはつらいヤツ</div>
        <div class="points">20</div>
      </div>

      <div class="challenge" onclick="openModal('Crypto', 'Lets cook1')">
        <div>Let's cook1</div>
        <div class="points">30</div>
      </div>

      <div class="challenge" onclick="openModal('Crypto', 'それはφです！')">
        <div>それはφです！</div>
        <div class="points">100</div>
      </div>
    </div>

    <!--カテゴリー名-->
    <h1>Cmd</h1>
    <div class="grid">
      <!--各問題のタイトル-->
      <div class="challenge" onclick="openModal('Cmd', 'cp')">
        <div>cp</div>
        <div class="points">15</div>
      </div>

      <div class="challenge" onclick="openModal('Cmd', 'chmod')">
        <div>chmod</div>
        <div class="points">20</div>
      </div>

      <div class="challenge" onclick="openModal('Cmd', 'rm')">
        <div>rm</div>
        <div class="points">30</div>
      </div>

      <div class="challenge" onclick="openModal('Cmd', 'grep')">
        <div>grep</div>
        <div class="points">100</div>
      </div>
    </div>
  </div>

  <!-- モーダル -->
  <div id="modal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal()">&times;</span>
      <h2 id="modal-title"></h2>
      <p id="modal-desc"></p>

      <input type="text" id="flagInput" placeholder="FLAG{...}">
      <button onclick="submitFlag()">Submit</button>
    </div>
  </div>


  <!--得点表示-->
  <div id="score" class="tab-content">
    <h2>得点</h2>
    <p id="scoreDisplay">現在の得点: -</p>
    <button onclick="loadScore()">最新スコア取得</button>
  </div>

  <!--ランキング表示-->
  <div id="result_check" class="tab-content">
    <h2>ランキング</h2>
    <table id="ranking">
    <thead>
      <tr><th>順位</th><th>ユーザー名</th><th>スコア</th></tr>
    </thead>
    <tbody>
        
    </tbody>
    </table>
      <p>ちょっと形になったよ</p>
    </div>
  </div>

  <script>
    // ログイン処理
    document.getElementById("loginForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const data = {
        userid: e.target.userid.value,
        password: e.target.password.value
      };

      const res = await fetch("/login", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data)
      });
      const result = await res.json();

      if (result.success) {
        document.getElementById("loginMessage").innerText = "";
        document.getElementById("loginSection").classList.add("hidden");
        document.getElementById("mainSection").classList.remove("hidden");
        document.getElementById("registerForm").classList.add("hidden");
        document.getElementById("welcome").innerText = "ようこそ " + result.username + " さん！";
      } else {
        document.getElementById("loginMessage").innerText = result.message;
      }
    });

    // タブ切り替え
    const tabs = document.querySelectorAll(".tab");
    const contents = document.querySelectorAll(".tab-content");

    tabs.forEach(tab => {
      tab.addEventListener("click", () => {
        // すべてのタブ・内容をいったん非アクティブにする
        tabs.forEach(t => t.classList.remove("active"));
        contents.forEach(c => c.classList.remove("active"));
        // クリックされたタブと、そのタブに対応する内容だけを表示
        tab.classList.add("active");
        document.getElementById(tab.dataset.target).classList.add("active");
        if (tab.dataset.target === "result_check") {
        loadRanking(); // ← ランキングタブを開いたとき実行
    }
      });
    });

    // スコア読み込み
    async function loadScore() {
      const res = await fetch("/getScore");
      const result = await res.json();
      document.getElementById("scoreDisplay").innerText = "現在の得点: " + result.score;
    }

    //スコアランキング
    async function loadRanking() {
      const res = await fetch("/ranking");
      const data = await res.json();

      const tbody = document.querySelector("#ranking tbody");
      tbody.innerHTML = "";

      data.forEach((user, index) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${index + 1}</td>
          <td>${user.userid || user.username}</td>
          <td>${user.score}</td>
        `;
        tbody.appendChild(tr);
      });
    }
    
  // 問題データ（ここに説明文などを書く）
  const questions = {
    TEST:{
      test1: {
        title: "test1",
        desc: "answer1"
      },
      test2: {
        title: "test2",
        desc: "answer2"
      },
      test3: {
        title: "test3",
        desc: "answer3"
      },
      test4: {
        title: "test4",
        desc: "answer4"
      }
    },

    Reversing : {
      want_to_execute: {
        title: "want_to_execute - Hidden Flag",
        desc: "この問題ではHTMLの中に隠されたFLAGを見つけてください。"
      },
      Passchecker: {
        title: "Passchecker - Easy Binary",
        desc: "与えられた実行ファイルを解析してパスワードを探してください。"
      },
      "Password Crack!": {
        title: "Password Crack! - Caesar Cipher",
        desc: "FLAG{Crypto} をシーザー暗号(+1)して答えを入力してください。"
      },
      "Ghidra Tutorial": {
        title: "Ghidra Tutorial - Simple Math",
        desc: "2 + 2 * 2 = ?"
      }
    },
    Web: {
      web1: {
        title: "web1 - Hidden Flag",
        desc: "この問題ではHTMLの中に隠されたFLAGを見つけてください。"
      },
      web2: {
        title: "web2 - Easy Binary",
        desc: "与えられた実行ファイルを解析してパスワードを探してください。"
      },
      web3: {
        title: "web3 - Caesar Cipher",
        desc: "FLAG{Crypto} をシーザー暗号(+1)して答えを入力してください。"
      },
      web4: {
        title: "web4 - Simple Math",
        desc: "2 + 2 * 2 = ?"
      }
    },

    Pwn: {
      Super_Command1: {
        title: "Super_Command1 - Hidden Flag",
        desc: "この問題ではHTMLの中に隠されたFLAGを見つけてください。"
      },
      Super_Command2: {
        title: "Super_Command2 - Easy Binary",
        desc: "与えられた実行ファイルを解析してパスワードを探してください。"
      },
      Super_Command3: {
        title: "Super_Command3 - Caesar Cipher",
        desc: "FLAG{Crypto} をシーザー暗号(+1)して答えを入力してください。"
      },
      Super_Command4: {
        title: "Super_Command4 - Simple Math",
        desc: "2 + 2 * 2 = ?"
      }
    },
    Crypto: {
      ROT: {
        title: "ROT - Hidden Flag",
        desc: "この問題ではHTMLの中に隠されたFLAGを見つけてください。"
      },
      "手動でやるのはつらいヤツ": {
        title: "手動でやるのはつらいヤツ - Easy Binary",
        desc: "与えられた実行ファイルを解析してパスワードを探してください。"
      },
      "Lets cook1": {
        title: "Let's cook1 - Caesar Cipher",
        desc: "FLAG{Crypto} をシーザー暗号(+1)して答えを入力してください。"
      },
      "それはφです！": {
        title: "それはφです！ - Simple Math",
        desc: "2 + 2 * 2 = ?"
      }
    },

    Cmd: {
      cp: {
        title: "cp - Hidden Flag",
        desc: "この問題ではHTMLの中に隠されたFLAGを見つけてください。"
      },
      chmod: {
        title: "chmod - Easy Binary",
        desc: "与えられた実行ファイルを解析してパスワードを探してください。"
      },
      rm: {
        title: "rm - Caesar Cipher",
        desc: "FLAG{Crypto} をシーザー暗号(+1)して答えを入力してください。"
      },
      grep: {
        title: "grep - Simple Math",
        desc: "2 + 2 * 2 = ?"
      }
    },
    PPC: {
      "Scratch Lv.1": {
        title: "Scratch Lv.1 - Hidden Flag",
        desc: "この問題ではHTMLの中に隠されたFLAGを見つけてください。"
      },
      "Scratch Lv.2": {
        title: "Scratch Lv.2 - Easy Binary",
        desc: "与えられた実行ファイルを解析してパスワードを探してください。"
      }
    },

    OSINT: {
      "People Search": {
        title: "People Search",
        desc: "私が通っている大学は創立100年を超える。この大学の設立者はどうやら様々な職業で活躍しており、新聞の創刊にもかかわっていたようだ。ほかにも本や論説の執筆などを行いこの国の近代化、啓蒙思想の普及に貢献し、国の変革期に大きな影響を与えた。 長らく人々の身近にその姿が印象として刻まれていたが、最近では日常の中でふと見かけることも少なくなった。時が経てば、その名を耳にすることも次第に減っていくのかもしれない。この文章が示す人物は誰だろうか？"
      },
      "You are here": {
        title: "You are here",
        desc: "これはどこの駅の案内図でしょうか?正解が京都駅の場合のフラグはCSL24{京都駅}です。"
        //ここに画像のダウンロードリンクを張る
        //<a href="画像のURL" download>画像をダウンロード</a>
      },
      "Where are you": {
        title: "Where are you",
        desc: "これはどこの駅の案内図でしょうか?正解が京都駅の場合のフラグはCSL24{京都駅}です。"
        //ここに画像のダウンロードリンクを張る
        //<a href="画像のURL" download>画像をダウンロード</a>
      },
      "Flight record": {
        title: "Flight record",
        desc: "配布された画像から、このフライトが行われた日時を西暦で答えよ。例:CSL24{〇年〇月〇日}"
                //ここに画像のダウンロードリンクを張る
        //<a href="画像のURL" download>画像をダウンロード</a>
      },
      "ここはココア？": {
        title: "ここはココア？",
        desc: "2 + 2 * 2 = ?"
      },
      "Cyberstalking1 ~Story~": {
        title: "Cyberstalking1 ~Story~ ",
        desc: "2 + 2 * 2 = ?"
      },
      "ONNN-K": {
        title: "ONNN-K",
        desc: "2 + 2 * 2 = ?"
      },
      "一休み": {
        title: "一休み",
        desc: "2 + 2 * 2 = ?"
      },
      "ramen with me": {
        title: "ramen with me - Simple Math",
        desc: "2 + 2 * 2 = ?"
      },
      park: {
        title: "park? - Simple Math",
        desc: "2 + 2 * 2 = ?"
      },
      "Cyberstalking1 ~Tweet~": {
        title: "Cyberstalking1 ~Tweet~ - Simple Math",
        desc: "2 + 2 * 2 = ?"
      },
      "Cyberstalking2 ~Tweet~": {
        title: "Cyberstalking2 ~Tweet~ - Simple Math",
        desc: "2 + 2 * 2 = ?"
      }
    },

  };

    // モーダルを開く
  function openModal(category, id) {
    const modal = document.getElementById("modal");
    modal.style.display = "flex";

    // 選ばれた問題データを反映
    const q = questions[category][id];
    document.getElementById("modal-title").textContent = q.title;
    document.getElementById("modal-desc").textContent = q.desc;
  }

    // モーダルを閉じる
  function closeModal() {
    document.getElementById("modal").style.display = "none";
  }

    // 背景クリックでも閉じられるように
  window.onclick = function(event) {
    const modal = document.getElementById("modal");
    if (event.target === modal) {
      closeModal();
    }
  };

  document.getElementById('modal-content').addEventListener('submit', async function(e){
  e.preventDefault(); // ページリロード防止
  const answer = document.getElementById('answer').value;

  // サーバーに送信
  const response = await fetch('/check-answer', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({answer})
  });

  const data = await response.json();
  document.getElementById('result').innerText = data.correct ? "正解！" : "不正解…";
});
  </script>
</body>
</html>
