# Apache/Nginx サーバー設定ガイド

## 推奨: Nginx

このNode.jsアプリケーションには**Nginx**を推奨します。

### 理由
- ✅ 軽量で高パフォーマンス
- ✅ リバースプロキシとして優秀
- ✅ WebSocket（Socket.IO）のサポートが良好
- ✅ 設定がシンプル
- ✅ メモリ使用量が少ない

---

## Nginx セットアップ手順（Windows）

### 1. Nginxのダウンロードとインストール

1. [Nginx公式サイト](http://nginx.org/en/download.html)からWindows版をダウンロード
2. 解凍して `C:\nginx` に配置（任意の場所でも可）

### 2. 設定ファイルの配置

1. このディレクトリの `nginx.conf` をコピー
2. `C:\nginx\conf\nginx.conf` をバックアップ
3. コピーした `nginx.conf` を `C:\nginx\conf\nginx.conf` に配置
4. 必要に応じて設定を調整

### 3. Nginxの起動

```powershell
# Nginxの起動
cd C:\nginx
start nginx

# 設定ファイルの再読み込み
nginx -s reload

# Nginxの停止
nginx -s stop
```

### 4. 動作確認

- ブラウザで `http://localhost` にアクセス
- Node.jsアプリが正常に動作することを確認

### 5. ファイアウォール設定（必要に応じて）

```powershell
# ポート80を許可
New-NetFirewallRule -DisplayName "Nginx HTTP" -Direction Inbound -Protocol TCP -LocalPort 80 -Action Allow
```

### 6. Serverヘッダーの削除（CTF問題用）

sadserverなどのCTF問題でResponseHeadersのServerヘッダーがチェックされる場合、以下の設定が適用されています：

- `server_tokens off;` - Nginxのバージョン情報を隠す（Server: nginx になる）
- `proxy_hide_header Server;` - バックエンドからのServerヘッダーを隠す

これにより、Serverヘッダーは `Server: nginx` になります（バージョン情報なし）。

**完全にServerヘッダーを削除する場合**（CTF問題で必須の場合）:
1. `headers-more-nginx-module` が必要です
2. Nginxをソースからコンパイルする必要があります
3. `nginx-no-server-header.conf` を参考にしてください

**設定の確認方法**:
```powershell
# レスポンスヘッダーを確認
curl -I http://localhost
```

現在の設定では、Serverヘッダーは `Server: nginx` として表示されます。

---

## Apache セットアップ手順（Windows）

### 1. Apacheのダウンロードとインストール

1. [Apache Lounge](https://www.apachelounge.com/download/)からWindows版をダウンロード
2. 解凍して `C:\Apache24` に配置（任意の場所でも可）

### 2. 必要なモジュールの有効化

`C:\Apache24\conf\httpd.conf` を編集して、以下のモジュールのコメントを外す：

```apache
LoadModule proxy_module modules/mod_proxy.so
LoadModule proxy_http_module modules/mod_proxy_http.so
LoadModule proxy_wstunnel_module modules/mod_proxy_wstunnel.so
LoadModule rewrite_module modules/mod_rewrite.so
LoadModule headers_module modules/mod_headers.so
```

### 3. 設定ファイルの追加

1. このディレクトリの `apache.conf` の内容をコピー
2. `C:\Apache24\conf\extra\ctf.conf` として保存
3. `C:\Apache24\conf\httpd.conf` の最後に以下を追加：

```apache
Include conf/extra/ctf.conf
```

### 4. Apacheの起動

```powershell
# Apacheの起動
cd C:\Apache24\bin
.\httpd.exe -k start

# 設定ファイルの再読み込み
.\httpd.exe -k restart

# Apacheの停止
.\httpd.exe -k stop
```

### 5. 動作確認

- ブラウザで `http://localhost` にアクセス
- Node.jsアプリが正常に動作することを確認

---

## トラブルシューティング

### ポートが既に使用されている場合

- **Nginx**: `nginx.conf` の `listen 80;` を別のポート（例: `listen 8080;`）に変更
- **Apache**: `apache.conf` の `<VirtualHost *:80>` を `<VirtualHost *:8080>` に変更

### Node.jsアプリに接続できない場合

1. Node.jsアプリが `127.0.0.1:3333` で起動していることを確認
2. ファイアウォール設定を確認
3. ログファイルを確認：
   - Nginx: `C:\nginx\logs\error.log`
   - Apache: `C:\Apache24\logs\error.log`

### WebSocket（Socket.IO）が動作しない場合

- Nginx: `nginx.conf` の `/socket.io/` セクションを確認
- Apache: `mod_proxy_wstunnel` モジュールが有効になっているか確認

---

## パフォーマンス比較

| 項目 | Nginx | Apache |
|------|-------|--------|
| メモリ使用量 | 少ない | 多い |
| 同時接続数 | 多い | 中程度 |
| 設定の複雑さ | シンプル | やや複雑 |
| WebSocketサポート | 優秀 | 良好 |
| 静的ファイル配信 | 高速 | 高速 |

---

---

## HTTPS設定（SSL/TLS証明書）

ブラウザで「insecure connection」の警告が表示される場合、HTTPSを有効化できます。

### 1. 自己署名証明書の生成

```powershell
# PowerShellで実行
.\generate-ssl-cert.ps1
```

または、OpenSSLがインストールされている場合：

```powershell
# SSL証明書ディレクトリを作成
mkdir C:\nginx\ssl

# 証明書を生成
openssl req -x509 -nodes -days 365 -newkey rsa:2048 `
  -keyout C:\nginx\ssl\key.pem `
  -out C:\nginx\ssl\cert.pem `
  -subj "/CN=192.168.56.1/O=CTF Server/C=JP"
```

### 2. Nginx設定の有効化

`nginx.conf` のHTTPS設定部分のコメントを外し、証明書のパスを確認：

```nginx
server {
    listen 443 ssl http2;
    server_name localhost 192.168.56.1;
    
    ssl_certificate C:/nginx/ssl/cert.pem;
    ssl_certificate_key C:/nginx/ssl/key.pem;
    # ... その他の設定
}
```

### 3. HTTPからHTTPSへのリダイレクト（オプション）

HTTPアクセスを自動的にHTTPSにリダイレクトする場合：

```nginx
server {
    listen 80;
    server_name localhost 192.168.56.1;
    return 301 https://$server_name$request_uri;
}
```

### 4. Nginxの再起動

```powershell
nginx -s reload
```

### 5. ブラウザでのアクセス

- `https://192.168.56.1` にアクセス
- 自己署名証明書の警告が表示されます
- 「詳細設定」→「続行」を選択してアクセス

**注意**: 自己署名証明書は開発環境用です。本番環境では正式な証明書（Let's Encryptなど）を使用してください。

---

## 次のステップ

- ログローテーションの設定
- レート制限の調整
- キャッシュの設定

