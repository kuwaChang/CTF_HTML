# Apache設定ファイル
# Windowsの場合: C:\Apache24\conf\httpd.conf に追加
# または、C:\Apache24\conf\extra\ctf.conf として保存して
# httpd.confに Include conf/extra/ctf.conf を追加

# 必要なモジュールを有効化（httpd.confで確認）
# LoadModule proxy_module modules/mod_proxy.so
# LoadModule proxy_http_module modules/mod_proxy.so
# LoadModule proxy_wstunnel_module modules/mod_proxy_wstunnel.so
# LoadModule rewrite_module modules/mod_rewrite.so
# LoadModule headers_module modules/mod_headers.so

# 仮想ホスト設定
<VirtualHost *:80>
    # サーバー名（ドメイン名またはIPアドレス）
    ServerName localhost
    ServerAlias 192.168.56.1

    # ドキュメントルート（静的ファイル用、オプション）
    # DocumentRoot "C:/Users/kokoh/CTF/CTF_HTML/public"
    
    # ログ設定
    ErrorLog logs/ctf_error.log
    CustomLog logs/ctf_access.log common

    # プロキシ設定
    ProxyPreserveHost On
    ProxyRequests Off

    # WebSocket（Socket.IO）用の設定
    RewriteEngine On
    RewriteCond %{HTTP:Upgrade} websocket [NC]
    RewriteCond %{HTTP:Connection} upgrade [NC]
    RewriteRule ^/socket.io/(.*)$ ws://127.0.0.1:3333/socket.io/$1 [P,L]

    # Socket.IO用のプロキシ設定
    <Location /socket.io/>
        ProxyPass ws://127.0.0.1:3333/socket.io/
        ProxyPassReverse ws://127.0.0.1:3333/socket.io/
        
        # WebSocket用のヘッダー
        ProxySet Upgrade websocket
        ProxySet Connection "Upgrade"
    </Location>

    # 通常のHTTPリクエストをNode.jsアプリにプロキシ
    <Location />
        ProxyPass http://127.0.0.1:3333/
        ProxyPassReverse http://127.0.0.1:3333/
        
        # プロキシヘッダー設定
        ProxyAddHeaders On
        RequestHeader set X-Forwarded-Proto "http"
        RequestHeader set X-Real-IP "%{REMOTE_ADDR}s"
    </Location>

    # タイムアウト設定（WebSocket用に長めに設定）
    ProxyTimeout 3600
    Timeout 3600
</VirtualHost>

# HTTPS設定（オプション - SSL証明書がある場合）
# <VirtualHost *:443>
#     ServerName localhost
#     ServerAlias 192.168.56.1
#     
#     SSLEngine on
#     SSLCertificateFile "C:/path/to/cert.pem"
#     SSLCertificateKeyFile "C:/path/to/key.pem"
#     
#     ProxyPreserveHost On
#     ProxyRequests Off
#     
#     RewriteEngine On
#     RewriteCond %{HTTP:Upgrade} websocket [NC]
#     RewriteCond %{HTTP:Connection} upgrade [NC]
#     RewriteRule ^/socket.io/(.*)$ wss://127.0.0.1:3333/socket.io/$1 [P,L]
#     
#     <Location /socket.io/>
#         ProxyPass wss://127.0.0.1:3333/socket.io/
#         ProxyPassReverse wss://127.0.0.1:3333/socket.io/
#         ProxySet Upgrade websocket
#         ProxySet Connection "Upgrade"
#     </Location>
#     
#     <Location />
#         ProxyPass http://127.0.0.1:3333/
#         ProxyPassReverse http://127.0.0.1:3333/
#         ProxyAddHeaders On
#         RequestHeader set X-Forwarded-Proto "https"
#         RequestHeader set X-Real-IP "%{REMOTE_ADDR}s"
#     </Location>
#     
#     ProxyTimeout 3600
#     Timeout 3600
# </VirtualHost>

