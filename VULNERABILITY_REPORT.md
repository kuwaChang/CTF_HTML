# 脆弱性チェックレポート

## 実行日時
2024年（現在の日時）

## 概要
CTF_HTMLプロジェクトのセキュリティ脆弱性をチェックしました。

---

## 🔴 重大な脆弱性

### 1. SQLインジェクション（意図的 - 学習用）
**場所**: `server.js` 427行目、467行目  
**深刻度**: 🔴 高  
**状態**: 意図的に残されている（学習用）

```javascript
// server.js:432
const query = `SELECT * FROM users WHERE username = '${username}' AND password = '${password}'`;

// server.js:471
const query = `SELECT * FROM users WHERE username LIKE '%${searchTerm}%' OR email LIKE '%${searchTerm}%'`;
```

**説明**: 
- `/login` と `/search` エンドポイントで、ユーザー入力を直接SQLクエリに埋め込んでいます
- これは学習用として意図的に残されている脆弱性です

**推奨対策**:
- パラメータ化クエリを使用（他のエンドポイントでは既に実装済み）
- 例: `db.get("SELECT * FROM users WHERE username = ? AND password = ?", [username, password])`

---

### 2. XSS（Cross-Site Scripting）✅ **修正済み**
**場所**: `public/js/quiz.js` 複数箇所  
**深刻度**: 🔴 高  
**状態**: ✅ 修正完了

**修正前**:
```javascript
// quiz.js:220
descElement.innerHTML = `${q.desc}<br><a href="${q.url}" target="_blank" style="color: #0078ff; text-decoration: underline; font-weight: 600;">${q.url}</a>`;
```

**修正内容**:
以下の箇所で `innerHTML` を安全なDOM操作に置き換えました：

1. **問題説明とURL表示** (220行目付近)
   - `textContent` と `createElement` を使用
   - URL検証を追加（`javascript:`, `data:`, `vbscript:` をブロック）
   - `rel="noopener noreferrer"` を追加

2. **問題タイトル表示** (42行目付近)
   - `q.title` と `q.point` を `textContent` で安全に表示

3. **ファイルリンク生成** (280行目付近)
   - ファイル名とカテゴリ名をサニタイズ
   - パストラバーサル対策を追加

4. **エラーメッセージ表示** (755行目、921行目)
   - `error.message` を `textContent` で安全に表示

5. **Rizin Web UI URL表示** (978行目、982行目、993行目)
   - `webUIUrl` と `data.suggestion`、`data.log` を安全に処理
   - URL検証を追加

**修正後の実装例**:
```javascript
// 安全なDOM操作
descElement.textContent = "";
if (q.desc) {
  descElement.textContent = q.desc;
}

if (q.url) {
  const br = document.createElement("br");
  descElement.appendChild(br);
  
  const link = document.createElement("a");
  try {
    const urlObj = new URL(q.url, window.location.href);
    if (urlObj.protocol === 'javascript:' || urlObj.protocol === 'data:' || urlObj.protocol === 'vbscript:') {
      link.textContent = q.url; // リンクとして機能させない
    } else {
      link.href = urlObj.href;
      link.target = "_blank";
      link.rel = "noopener noreferrer";
      link.textContent = q.url;
    }
  } catch (e) {
    link.textContent = q.url;
  }
  descElement.appendChild(link);
}
```

---

## 🟡 中程度の脆弱性

### 3. 管理者認証の脆弱性 ✅ **修正済み**
**場所**: `routes/admin.js` 59-68行目  
**深刻度**: 🟡 中  
**状態**: ✅ 修正完了

**修正前**:
```javascript
function requireAdmin(req, res, next) {
  if (req.session.userid === "admin") {
    console.log("✅ 管理者認証OK");
    next();
  }
  else {
    console.log("❌ 認証失敗:", req.session.userid);
    res.status(403).send("アクセス権がありません（管理者専用）");
  }
}
```

**修正内容**:
roleベースの認証システムを実装しました：

1. **データベーススキーマの更新** (`server.js`)
   - `users` テーブルに `role` カラムを追加（デフォルト値: 'user'）
   - 既存のadminユーザーにroleを設定するマイグレーションを追加

2. **ユーザー登録の更新** (`routes/auth.js`)
   - 新規ユーザー登録時に `role` を 'user' に設定

3. **ログイン処理の更新** (`routes/auth.js`)
   - データベースから `role` を取得
   - セッションに `userid` と `role` を保存

4. **管理者認証ミドルウェアの更新** (`routes/admin.js`)
   - `req.session.role === "admin"` で認証
   - ログイン状態も確認

5. **セッション確認APIの更新** (`server.js`)
   - `role` 情報も返すように更新
   - セッションとデータベースのroleを同期

**修正後の実装**:
```javascript
// 管理者認証ミドルウェア（roleベース認証）
function requireAdmin(req, res, next) {
  // セキュリティ: ログイン状態を確認
  if (!req.session.userid) {
    console.log("❌ 認証失敗: ログインしていません");
    return res.status(401).json({ error: "ログインが必要です" });
  }
  
  // セキュリティ: roleベースの認証（データベースから取得したroleを使用）
  if (req.session.role === "admin") {
    console.log("✅ 管理者認証OK:", req.session.userid);
    next();
  }
  else {
    console.log("❌ 認証失敗: 管理者権限がありません", { userid: req.session.userid, role: req.session.role });
    res.status(403).json({ error: "アクセス権がありません（管理者専用）" });
  }
}
```

**セキュリティ向上のポイント**:
- データベースベースのrole管理により、より安全な認証が可能
- セッション固定攻撃に対する耐性向上
- 将来的に複数のロール（admin, moderator, user等）を追加可能

---

### 4. ファイルパストラバーサルの可能性 ✅ **修正済み**
**場所**: `public/js/quiz.js`、`server.js`  
**深刻度**: 🟡 中  
**状態**: ✅ 修正完了

**修正前**:
```javascript
// quiz.js:280
const fileLinks = q.files.map(f => 
  `<a href="files/${category}/${f}" download class="download-btn">📄 ${f}</a>`
).join("<br>");
```

**修正内容**:
サーバー側でファイルダウンロードエンドポイントを作成し、パストラバーサル対策を実装しました：

1. **サーバー側エンドポイントの作成** (`server.js`)
   - `/files/:category/:filename` エンドポイントを追加
   - 認証チェックを実装（ログイン必須）
   - カテゴリ名とファイル名のサニタイゼーション
   - `path.resolve()` を使用してパストラバーサルを防止
   - 許可されたディレクトリ内のファイルのみアクセス可能

2. **クライアント側の更新** (`public/js/quiz.js`)
   - サーバーエンドポイント経由でファイルをダウンロード
   - ファイル名とカテゴリ名のサニタイゼーション（二重チェック）

3. **管理者APIの強化** (`routes/admin.js`)
   - カテゴリ名のサニタイゼーションを追加

**修正後の実装**:
```javascript
// server.js: ファイルダウンロードエンドポイント
app.get("/files/:category/:filename", (req, res) => {
  // 認証チェック
  if (!req.session.userid) {
    return res.status(401).json({ error: "ログインが必要です" });
  }
  
  // パラメータのサニタイゼーション
  const sanitizedCategory = sanitizePathComponent(req.params.category);
  const sanitizedFilename = sanitizePathComponent(req.params.filename);
  
  // サニタイズ後の値が元の値と一致するか確認
  if (req.params.category !== sanitizedCategory || req.params.filename !== sanitizedFilename) {
    return res.status(400).json({ error: "無効なパラメータです" });
  }
  
  // パストラバーサル対策: path.resolve()で正規化
  const filesDir = path.join(__dirname, "public", "files");
  const filePath = path.join(filesDir, sanitizedCategory, sanitizedFilename);
  const resolvedFilesDir = path.resolve(filesDir);
  const resolvedFilePath = path.resolve(filePath);
  
  // 許可されたディレクトリ内にあることを確認
  if (!resolvedFilePath.startsWith(resolvedFilesDir)) {
    return res.status(403).json({ error: "アクセスが拒否されました" });
  }
  
  // ファイルを送信
  res.sendFile(filePath);
});
```

**セキュリティ向上のポイント**:
- サーバー側での厳密なパス検証
- `path.resolve()` によるパストラバーサル防止
- 許可されたディレクトリ内のファイルのみアクセス可能
- 認証チェックにより、未認証ユーザーからのアクセスを防止

---

### 5. コマンドインジェクションのリスク
**場所**: `server-sad.js` 18行目、309行目  
**深刻度**: 🟡 中（緩和済み）

```javascript
// server-sad.js:18
const instanceId = namespace.name.split("/").pop();

// server-sad.js:309
const filePath = req.body && req.body.filePath || "/challenge/sample_binary";
```

**説明**:
- `instanceId` は正規表現で検証されているため比較的安全（270行目、316行目）
- `filePath` は検証されていないが、Dockerコンテナ内で実行されるため影響は限定的

**推奨対策**:
- `filePath` の検証を追加
- 許可されたパスのみ許可（例: `/challenge/` で始まるパスのみ）

---

## 🟢 低リスク / 改善提案

### 6. セッション設定
**場所**: `server.js` 175-188行目  
**深刻度**: 🟢 低

```javascript
cookie: {
  maxAge: 24 * 60 * 60 * 1000,  // 1日
  sameSite: "lax",
  httpOnly: true,  // XSS対策: JavaScriptからアクセス不可
  secure: false,   // HTTPS使用時はtrueに変更（LAN内なのでfalseのまま）
  path: "/"
}
```

**説明**:
- `secure: false` のため、HTTPS環境ではセッションクッキーが保護されません
- LAN内での使用を想定しているため、現状は許容範囲

**推奨対策**:
- 本番環境では `secure: true` に設定
- 環境変数で制御: `secure: process.env.NODE_ENV === 'production'`

---

### 7. エラーメッセージの情報漏洩
**場所**: `server.js` 438行目、477行目  
**深刻度**: 🟢 低

```javascript
// server.js:438
return res.json({
  success: false,
  message: "エラー: " + err.message,
  query: query  // SQLクエリを返している
});
```

**説明**:
- SQLエラーメッセージとクエリをクライアントに返している
- データベース構造の情報が漏洩する可能性

**推奨対策**:
- エラーメッセージを一般化
- デバッグ時のみ詳細を返す（環境変数で制御）

---

### 8. CORS設定
**場所**: `server.js` 144-173行目  
**深刻度**: 🟢 低

**説明**:
- LAN内のみアクセス可能な設定になっている
- プライベートIPの検証が実装されている

**推奨対策**:
- 本番環境では、より厳密なオリジン指定を推奨

---

## ✅ 良好な実装

### 実装済みのセキュリティ対策

1. **パラメータ化クエリ**: `routes/auth.js` で適切に実装
2. **パスワードハッシュ化**: bcryptを使用
3. **レート制限**: ブルートフォース対策が実装済み
4. **入力検証**: `routes/auth.js` で実装済み
5. **ファイルアップロードのサニタイゼーション**: `routes/admin.js` で実装済み
6. **セッション管理**: httpOnlyクッキーを使用
7. **SQLインジェクション対策**: 主要なエンドポイントで実装済み（学習用を除く）

---

## 優先度別の修正推奨

### 即座に修正すべき（高優先度）
1. ✅ **完了** XSS対策: `quiz.js` の `innerHTML` 使用箇所を修正
2. ✅ **完了** 管理者認証の強化: ロールベースの認証を実装

### 中期的に修正すべき（中優先度）
3. ✅ ファイルパストラバーサル対策: ファイルダウンロード時のパス検証
4. ✅ エラーメッセージの一般化

### 長期的に改善すべき（低優先度）
5. ✅ セッション設定の環境変数化
6. ✅ セキュリティヘッダーの追加（Helmet.js等）

---

## 補足

- SQLインジェクションの脆弱性は学習用として意図的に残されています
- その他の脆弱性は本番環境で使用する前に修正を推奨します
- 定期的なセキュリティ監査を推奨します

