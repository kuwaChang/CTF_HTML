# アイコンアップロード攻撃ガイド

## 脆弱性の概要

アイコンアップロード機能（`/api/upload-icon`）には以下の脆弱性があります：

1. **MIMEタイプのみの検証**: 実際のファイル内容（マジックナンバー）を検証していない
2. **Content-Typeヘッダーの信頼**: クライアントから送られてくるContent-Typeをそのまま信頼している
3. **ファイル拡張子の検証不足**: 元のファイル名の拡張子を使用しているが、実際のファイル内容と一致しているか確認していない

## 攻撃方法

### 方法1: SVGファイルにXSSペイロードを埋め込む

SVGファイルはXMLベースなので、`<script>`タグを含むことができます。ただし、現在の実装では`image/svg+xml`は許可されていないため、Content-Typeを偽装する必要があります。

**手順:**
1. `icon_upload_xss.svg`ファイルを作成
2. ブラウザの開発者ツールでリクエストをインターセプト
3. Content-Typeを`image/png`に変更
4. ファイルをアップロード

### 方法2: ポリグロットファイルの作成

画像ファイルとしても有効だが、同時にスクリプトとしても実行可能なファイルを作成します。

**手順:**
1. 実際のPNGファイルの先頭にPNGマジックナンバー（89 50 4E 47）を配置
2. ファイル内にスクリプトコードを埋め込む
3. サーバーがファイルを画像として表示する際に、埋め込まれたスクリプトが実行される可能性がある

### 方法3: ファイル名による攻撃

ファイル名に特殊文字を使用して、パストラバーサルやコマンドインジェクションを試みます。

## 実際の攻撃シナリオ

### シナリオ1: XSS攻撃

1. 悪意のあるSVGファイルを`image/png`としてアップロード
2. アイコンが表示されるページで、埋め込まれたJavaScriptが実行される
3. セッション情報やクッキーが盗まれる

### シナリオ2: サーバーサイドスクリプト実行

1. ポリグロットファイル（例: PHPコードを含むGIF）をアップロード
2. サーバーがファイルを実行可能な場所に保存している場合、スクリプトが実行される
3. サーバーへの完全なアクセスが可能になる

## 対策

### 推奨される修正

1. **マジックナンバーの検証**: ファイルの実際の内容を確認
2. **ファイルタイプの再検証**: アップロード後にファイルタイプを再確認
3. **ファイルのサニタイゼーション**: 画像ライブラリを使用して画像を再生成
4. **実行可能ファイルの防止**: アップロードされたファイルを実行可能な場所に保存しない

### 実装例

```javascript
const fileType = require('file-type');

const iconFileFilter = async (req, file, cb) => {
  // マジックナンバーでファイルタイプを検証
  const buffer = file.buffer;
  const type = await fileType.fromBuffer(buffer);
  
  const allowedMimes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
  if (type && allowedMimes.includes(type.mime)) {
    cb(null, true);
  } else {
    cb(new Error('画像ファイルのみアップロードできます'));
  }
};
```

## テスト方法

1. 攻撃用ファイルを準備
2. ブラウザの開発者ツールでネットワークタブを開く
3. アイコンアップロードリクエストをインターセプト
4. Content-Typeを変更してアップロード
5. アップロードされたファイルがどのように処理されるか確認


